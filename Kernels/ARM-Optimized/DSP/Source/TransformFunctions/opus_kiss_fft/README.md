# Opus CELT FFT using ARM Helium Vector Extension

Opus CELT Kiss 32-bit Fixed-point FFT using ArmV8.1-M with Helium Vector Extension

The core of this library has been extracted from the **Opus CELT** MDCT part.
(See https://github.com/xiph/opus/)

As mentioned in the kiss_fft.c header:

> This code is originally from Mark Borgerding's KISS-FFT but has been heavily modified to better suit Opus

**KISS FFT** is a mixed-radix Fast Fourier Transform based up on the principle, "Keep It Simple, Stupid."


## Goals

The goal of this library is to provide additional Helium optimized FFT Radixes not natively covered by the CMSIS DSP currently and enabling more possible FFT lengths.

This library is currently limited to 32-bit fixed-point but can be extended on demand.

It can also be integrated in the opus codec and benefit from Helium acceleration.

## Build

The Makefile will build an archive with both default C and the Helium FFT versions which can be compared in terms of accuracy and performance.

Arm Compiler (>= 6.15) is needed.

## Usage

Using the Opus Helium fft requires an extra initialization stage to prepare helpers enabling friendly vectorization.
An extra context is appended to the main Kiss FFT private context.

The size of this context is retrieved using **opus_fft_get_mve_ctx_size**
```cpp
uint32_t opus_fft_get_mve_ctx_size(const kiss_fft_state * st);
```

This context will be passed to **opus_fft_init_mve**
```cpp
void opus_fft_init_mve(const kiss_fft_state * st, void *mem);
```

As for opus FFT, **opus_fft_mve** or **opus_ifft_mve** will be invoked to run the forward and backward FFT

```cpp
void opus_fft_mve(const kiss_fft_state * st, const kiss_fft_cpx * fin,
                  	kiss_fft_cpx * fout);
void opus_ifft_mve(const kiss_fft_state *st,const kiss_fft_cpx * fin,
					kiss_fft_cpx *fout);
```

A test sample can be found in the main.c file

```cpp
    const kiss_fft_state *kfstate = opus_get_fft_ctx(fft_size);

    /* allocate Helium FFT context extension */
    int             heliumCtxSz = opus_fft_get_mve_ctx_size(kfstate);
    void           *heliumCtx = malloc(heliumCtxSz);
    if (heliumCtx == NULL) {
        printf("out of memory\n");
        exit(1);
    }
    memset(heliumCtx, 0, heliumCtxSz);

    /* initialize Helium FFT context extension */
    opus_fft_init_mve(kfstate, heliumCtx);

    opus_fft_mve(kfstate, fft_in, fft_out_mve);

    opus_ifft_mve(kfstate, fft_in, fft_out_mve);

```



## LIMITATIONS

Opus FFT sizes involved in MDCT covers length of **60, 120, 240 and 480**
Adding more sizes will require addition of static structures with twiddles and bit-reversed tables.

Those ones can be regenerated by running the **dump_modes** CELT application for custom modes.

Tested with ARM Compiler 6.17

Arm GCC has issue in compiling radix5 because of the register constraint with the inline asm part.
This function needs to be turned into full asm.


